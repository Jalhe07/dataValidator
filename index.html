<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Data validator</title>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    td.invalid { background-color: #ffd6d6; }
    td.valid { background-color: #d7ffd9; }
    textarea { width: 100%; height: 100px; margin-top: 10px; }
    select, button { font-size: 14px; margin-top: 10px; }
    .toolbar { margin-top: 10px; display: flex; gap: 10px; }
    td[contenteditable="true"]:focus { outline: 2px solid #4a90e2; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>üìã Coloca aqu√≠ tus datos</h2>
  <textarea id="pasteArea" placeholder="Ctrl + V pega aqu√≠ los datos sin encabezados de columna..."></textarea>

  <div class="toolbar">
    <button id="exportBtn">‚¨áÔ∏è Exportar a Excel</button>
    <button id="deleteRowsBtn">üóëÔ∏è Eliminar filas seleccionadas</button>
    <button id="clearAllBtn">üßπ Borrar todos los registros</button>
  </div>

  <table id="dataTable" spellcheck="false">
    <thead>
      <tr>
        <th>RAZ√ìN SOCIAL</th><th>CALLE</th><th>EXT</th><th>INT</th>
        <th>ENTRE CALLE</th><th>ENTRE CALLE2</th><th>CP</th><th>COLONIA</th>
        <th>LATITUD</th><th>LONGITUD</th><th>VALIDACI√ìN</th><th>GEO-DISTANCIA</th><th>‚úîÔ∏è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let sepomex = {};

    fetch("sepomex.json")
      .then(res => res.json())
      .then(data => { sepomex = data; })
      .catch(err => alert("Error cargando sepomex.json: " + err));

    const contieneCaracteresEspeciales = texto => /[^A-Z0-9\s]/.test(texto);
    const contieneAbreviaturas = texto => /\b(COL|AV|CALLE|NUM|NO|EXT|INT|ENTRE|CDA|MZ|LT|DEPTO)\b/.test(texto);

    const corregirCoordenada = (valor, tipo) => {
      if (!valor) return null;
      const match = valor.match(/^(-?\d{2,3})\.(\d{1,10})$/);
      if (!match) return null;

      const enterosConSigno = match[1];
      const enteros = enterosConSigno.replace('-', '');
      let decimales = match[2];

      let esperado;
      if (tipo === 'lat') esperado = 6;
      else if (tipo === 'lng') esperado = enteros.length === 3 ? 5 : 6;
      else esperado = 6;

      decimales = decimales.slice(0, esperado);
      while (decimales.length < esperado) decimales += '0';

      return `${enterosConSigno}.${decimales}`;
    };

    const calcularDistanciaKm = (lat1, lng1, lat2, lng2) => {
      const R = 6371;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lng2 - lng1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    };

    const pasteArea = document.getElementById("pasteArea");
    const tableBody = document.querySelector("#dataTable tbody");

    pasteArea.addEventListener("paste", e => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData("text");
      const rows = text.trim().split("\n");

      const esValido = rows.every(row => row.split("\t").length >= 10);
      if (!esValido) {
        alert("‚ö†Ô∏è Error al pegar datos: aseg√∫rate de incluir todas las columnas necesarias.");
        return;
      }

      tableBody.innerHTML = "";
      rows.forEach((row) => {
        const cols = row.split("\t").map(c => c.trim().toUpperCase());
        if (cols.length < 10) return;

        const tr = document.createElement("tr");
        cols.forEach((val) => {
          const td = document.createElement("td");
          td.contentEditable = true;
          td.textContent = val;
          tr.appendChild(td);
        });

        const tdValid = document.createElement("td");
        tr.appendChild(tdValid);

        const tdGeo = document.createElement("td");
        tr.appendChild(tdGeo);

        const tdCheckbox = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        tdCheckbox.appendChild(checkbox);
        tr.appendChild(tdCheckbox);

        tableBody.appendChild(tr);
        validarFila(tr);
      });
    });

    function validarFila(tr) {
      const cells = tr.querySelectorAll("td");
      const errores = [];
      const [
        razon,
        calle,
        ext,
        int,
        entre1,
        entre2,
        cp,
        col,
        lat,
        lng
      ] = Array.from(cells).slice(0,10).map(td => td.textContent.trim().toUpperCase());

      const cpValido = /^\d{5}$/.test(cp);
      const ref = sepomex[cp] || {};
      const cpExiste = cpValido && Object.keys(ref).length > 0;

      const marcar = (i, condicion, mensaje) => {
        cells[i].classList.remove("valid", "invalid");
        cells[i].classList.add(condicion ? "valid" : "invalid");
        if (!condicion && mensaje) errores.push(mensaje);
      };

      marcar(0, razon && !contieneCaracteresEspeciales(razon), "RAZ√ìN inv√°lida");
      marcar(1, calle && !contieneCaracteresEspeciales(calle) && !contieneAbreviaturas(calle), "CALLE inv√°lida");
      marcar(2, /^[A-Z0-9\s]+$/.test(ext), "EXT inv√°lido");
      marcar(3, !int || /^[A-Z0-9\s]+$/.test(int), "INT inv√°lido");
      marcar(4, !entre1 || (!contieneCaracteresEspeciales(entre1) && !contieneAbreviaturas(entre1)), "ENTRE CALLE inv√°lido");
      marcar(5, !entre2 || (!contieneCaracteresEspeciales(entre2) && !contieneAbreviaturas(entre2)), "ENTRE CALLE2 inv√°lido");
      marcar(6, cpExiste, "CP inv√°lido o inexistente");

      const coloniasValidas = Array.isArray(ref.colonias) ? ref.colonias.map(c => c.toUpperCase()) : [];

      if (cpExiste && !coloniasValidas.includes(col)) {
        const select = document.createElement("select");
        ref.colonias.forEach(option => {
          const opt = document.createElement("option");
          opt.textContent = opt.value = option;
          select.appendChild(opt);
        });
        select.addEventListener("change", () => {
          cells[7].textContent = select.value.toUpperCase();
          validarFila(tr);
        });
        cells[7].innerHTML = "";
        cells[7].appendChild(select);
        cells[7].classList.remove("valid");
        cells[7].classList.add("invalid");
        errores.push("COLONIA no coincide con CP");
      } else {
        marcar(7, coloniasValidas.includes(col), "COLONIA no coincide con CP");
      }

      const latFix = corregirCoordenada(lat, 'lat');
      const lngFix = corregirCoordenada(lng, 'lng');

      if (latFix) {
        cells[8].textContent = latFix;
        cells[8].classList.remove("invalid");
        cells[8].classList.add("valid");
      } else {
        cells[8].classList.remove("valid");
        cells[8].classList.add("invalid");
        errores.push("LATITUD inv√°lida");
      }

      if (lngFix) {
        cells[9].textContent = lngFix;
        cells[9].classList.remove("invalid");
        cells[9].classList.add("valid");
      } else {
        cells[9].classList.remove("valid");
        cells[9].classList.add("invalid");
        errores.push("LONGITUD inv√°lida");
      }

      let distancia = null;
      let mensajeDistancia = "‚ùå Sin validar";
      if (latFix && lngFix && ref.lat && ref.lng) {
        distancia = calcularDistanciaKm(+latFix, +lngFix, +ref.lat, +ref.lng);
        const zona = (ref.zona || "URBANA").toUpperCase();
        const umbral = zona === "RURAL" ? 5 : 3;
        if (!isNaN(distancia)) {
          mensajeDistancia = distancia <= umbral
            ? `‚úîÔ∏è ${distancia.toFixed(2)} km`
            : `‚ö†Ô∏è ${distancia.toFixed(2)} km (l√≠mite ${umbral} km)`;
        }
      }

      cells[10].textContent = errores.length ? errores.join(", ") : "‚úîÔ∏è V√ÅLIDO";
      cells[11].textContent = mensajeDistancia;
      cells[11].classList.remove("valid", "invalid");
      cells[11].classList.add(mensajeDistancia.startsWith("‚úîÔ∏è") ? "valid" : "invalid");
    }

    // Forzar may√∫sculas al escribir sin invertir texto
    tableBody.addEventListener("keydown", e => {
      if (e.target && e.target.tagName === "TD") {
        const colIndex = Array.from(e.target.parentElement.children).indexOf(e.target);
        if (colIndex < 10 && e.key.length === 1 && e.key.match(/[a-z]/i)) {
          e.preventDefault();
          document.execCommand("insertText", false, e.key.toUpperCase());
        }
      }
    });

    tableBody.addEventListener("input", e => {
      const tr = e.target.closest("tr");
      if (tr) validarFila(tr);
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      const wb = XLSX.utils.book_new();
      const ws_data = [];
      const headers = ["RAZ√ìN SOCIAL", "CALLE", "EXT", "INT", "ENTRE CALLE", "ENTRE CALLE2", "CP", "COLONIA", "LATITUD", "LONGITUD", "VALIDACI√ìN", "GEO-DISTANCIA"];
      ws_data.push(headers);
      tableBody.querySelectorAll("tr").forEach(tr => {
        const row = [];
        tr.querySelectorAll("td").forEach((td, idx) => {
          if (idx < 12) row.push(td.textContent.trim());
        });
        ws_data.push(row);
      });
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "Clientes Validados");
      XLSX.writeFile(wb, "clientes_validados.xlsx");
    });

    document.getElementById("deleteRowsBtn").addEventListener("click", () => {
      const rows = tableBody.querySelectorAll("tr");
      rows.forEach(tr => {
        const checkbox = tr.querySelector("input[type='checkbox']");
        if (checkbox && checkbox.checked) tr.remove();
      });
    });

    document.getElementById("clearAllBtn").addEventListener("click", () => {
      if (confirm("¬øEst√°s seguro de que deseas borrar todos los registros?")) {
        tableBody.innerHTML = "";
      }
    });
  </script>
</body>
</html>
